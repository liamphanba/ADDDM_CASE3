---
title: "Case Study 3"
author: "Michael Daniel Bigler and Liam Arthur Phan"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    code_folding: hide
    number_sections: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = TRUE,
	fig.align = "center")
rm(list = ls())
cat("\014")
```

# Packages {.unnumbered}

```{r}
library(psych)
library(corrplot)
library(ggplot2)
library(car)
library(naniar)
library(REdaS)
library(zoo)
library(foreign) 
library(lavaan)
```

# Data Loading

```{r}
df <- read.csv2('Case Study III_Structural Equation Modeling.csv', na.strings = '999', sep = ',')
df <- df[, c(1:23, 25:36)]
head(df)
```

```{r}
describe(df)
```

```{r}
dim(df)
```

```{r}
gg_miss_var(df, show_pct = TRUE)
```

This is not too bad. 

```{r}
naniar::vis_miss(df)
```

If we look at this plot though we see that the missing values are in a lot of the observations. Thereby we probably can not omit the data but need to replace it with the mean. 

```{r}
dim(na.omit(df))
```

```{r}
df <- na.aggregate(df)
```

# Exploratory Factor Analysis

For exploratory factor analysis: please only consider variables image1 to image22, and use listwise deletion to handle missing data before starting exploratory factor analysis.

From Assistant

## check assumptions

```{r}
df_1 <- df[,1:22]
```

```{r}
M <- cor(df_1)
corrplot(M, method='circle', number.cex = 0.5, tl.cex = 0.7)
```

Correlation matrix seems alright

```{r}
KMOTEST <- KMO(M)
sort(KMOTEST$MSAi)
```
no problems seen in each factors anti image correlation

```{r}
KMOTEST$MSA
```

With 0.89 sampling adequacy is very high. 

```{r}
cortest.bartlett(df_1)
```

Factor analysis can be done as the test indicates a p-value of 0.

## Factor analysis

```{r}
# parallel <- fa.parallel(df_1)
# parallel$fa.values
# parallel$pc.values
```

FA says 2, PCA says 5

```{r}
fa_result <- fa(df_1, rotate = "varimax", fm = "pa")
n_factors <- length(fa_result$e.values)
scree     <- data.frame(Factor_n =  as.factor(1:n_factors), Eigenvalue = fa_result$e.values)

ggplot(scree, aes(x = Factor_n, y = Eigenvalue, group = 1)) +
  geom_point() + geom_line() +
  xlab("Number of factors") +
  ylab("Initial eigenvalue") +
  labs( title = "Scree Plot",
        subtitle = "(Based on the unreduced correlation matrix)") +
  geom_hline(yintercept = 1)

factors_kaiser <- sum(fa_result$e.values>1)
```

According to factor analysis six factors.

```{r}
fa_result <- fa(df_1, rotate = "promax", fm = "pa", nfactors = 6)
colnames(fa_result$loadings) <- c('French cuisine', 'Appealing store', 'Large assortment', 'Luxury and high quality', 'Relaxing store', 'Hip and Trendy')
print(fa_result$loadings, cutoff=0.3,sort=TRUE)
```

With six factors we clear loadings except for some variables.

```{r}
sort(fa_result$communality)
```

Only some communalities under 0.5. Need to look out for lm11, lm16, lm9 and lm19

```{r}
fa.diagram(fa_result)
```

## Dimensions by which GLF is perceived? 

List factors that you get from the analysis

# Confirmatory Factor Analysis

For confirmatory factor analysis (CFA) and structural equation modeling (SEM), please use the raw data (which includes the missing values) to perform CFA and SEM, and use maximum likelihood (ML) to handle the missing data.

From Assistant

```{r}
model <- "
F1 =~Im6+Im7+Im8+Im10+Im14+Im9
F2 =~Im3+Im4+Im5
F3 =~Im1+Im2+Im15+Im16+Im19
F4 =~Im11+Im12+Im13
F5 =~Im20+Im21+Im22
F6 =~Im17+Im18+Im9+Im6
"
fit <- cfa(model, data=df_1)
summary(fit, fit.measures=TRUE, standardized=TRUE)
```

Remove Im16, Im9 and Im6

```{r}
library(dplyr)
modificationindices(fit) %>% filter(mi>10)
```
CFA looks alright we can do structure modelling

# Structure modelling on factors 

```{r}
model <- "
F1 =~Im6+Im7+Im8+Im10+Im14+Im9
F2 =~Im3+Im4+Im5
F3 =~Im1+Im2+Im15+Im16+Im19
F4 =~Im11+Im12+Im13
F5 =~Im20+Im21+Im22
F6 =~Im17+Im18+Im9+Im6

CS ~ F1 + F2 + F3 + F4 + F5 + F6
AC ~ F1 + F2 + F3 + F4 + F5 + F6

CS =~ SAT_1 + SAT_2 + SAT_3
AC =~ COM_A1 + COM_A2 + COM_A3 + COM_A4

RI =~ C_REP1 + C_REP2 + C_REP3
CI =~ C_CR1 + C_CR3 + C_CR4

RI ~ CS + AC + F1 + F2 + F3 + F4 + F5 + F6
CI ~ CS + AC + F1 + F2 + F3 + F4 + F5 + F6
"

fit10<-cfa(model, data=df, missing="ML")

inspect(fit10)
```

